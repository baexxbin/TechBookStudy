# 데이터 암호화

MySQL 8.0이되며 데이터 파일뿐만 아닌, 리두로그, 언두로그, 복제를 위한 바이너리 로그 등도 모두 암호화 기능을 지원하기 시작했다.

응용프로그램의 암호화는 주로 중요정보를 가진 컬럼 단위, 데이터베이스 수준에서는 테이블 단위로 암호화를 적용한다.

## MySQL서버의 데이터 암호화

MySQL서버의 암호화 기능은 데이터베이스 서버와 디스크 사이의 데이터를 읽고 쓰기 지점에서 암호화 또는 복호화를 수행한다.

따라서 그외의 부분에서는 암호화처리가 필요치 않다. 즉, MySQL서버의 I/O레이어에서만 데이터의 암호화 및 복호화 과정이 실행되는 것이다.

MySQL서버에서 사용자의 쿼리를 처리하는 과정에서 테이블 데이터가 암호화돼있는지 식별할 필요가 없으며, 암호화된 테이블도 그렇지 않은 테이블과 동일한 처리과정을 거친다.

왜냐하면 mYsql내부와 사용자 입장에서는 차이가 없기 때문이다. 이를 TDE(Transparent Data Encryption)이라고 한다. 디스크에 저장된 단계에서만 암호화된다는 의미이다.

### 2단계 키관리

TDE에서 암호화키는 KeyRing플러그인에 의해 관리된다. keyRing플러그인은 2단계 키 관리 방식을 사용한다.

**2단계 키관리방식**
MySQL서버의 데이터 암호화는 마스터키와 테이블스페이스 키 두가지 종류의 키를 가지고있다.

- 마스터키는 외부키 솔루션 또는 디스크파일로부터 가져온다.
- 테이블스페이스 키는 암호화된 테이블이 생성될때마다 임의로 발급된다.

테이블스페이스 키는 내부에서 생성되어 노출되지 않지만 마스터키는 외부로부터 가져오기때문에 노출의 위험이 있다. 따라서 주기적으로 변경해줘야한다.

### 암호화와 성능

TDE방식이기 때문에 디스크로부터 한번 읽은 데이터 페이지는 복호화되어 InnoDB의 버퍼풀에 적재된다. 따라서 한번 메모리에 적재되면 암호화되지 않은 테이블과 동일한 성능을 보인다.

하지만 쿼리가 InnoDB버퍼풀에 존재하지 않는 데이터 페이지를 읽어야하는 경우 복호화과정을 거쳐야하기 때문에 처리가 지연될 것이다.
또한 암호화된 테이블이 변경되어도 암호화한 다음 저장해야하여 추가적으로 시간이 걸린다.

하지만 데이터 입력은 백그라운드 쓰레드가 처리하기 때문에 실제 사용자의 쿼리가 지연되진 않는다.

### 암호화와 복제

TDE를 이용한 암호화 사용시 마스터키와 테이블스페이스키가 레플리카 서버로 복제되진 않는다. 따라서 키링을 잘 백업해둬야한다.

## 테이블 암호화

일반적인 테이블 생성 쿼리와 같지만 `ENCRYPTION='Y'`옵션만 넣어주면 된다.

### 응용 프로그램 암호화와의 비교

만약 응용프로그램에서 컬럼을 암호화하고 MySQL에 저장한다면, MySQL에서 인덱스의 기능을 온전히 사용하지 못한다.

예로들어 날짜에 대한 컬럼이 암호화되어 들어오면 해당 날짜를 MySQL에서는 인지하지 못하여 원하는 결과를 얻을수 없다.

### 테이블스페이스 이동

MySQL8.0부터 `innodb_undo_log_encrypt`와 `innodb_redo_log_encrypt`를 통해 리두와 언두로그를 암호화할수 있다.

테이블 암호화는 테이블에 암호화를 걸면 모든 데이터에 암호화가 되지만, 리두와 언두로그는 그렇게 할수 없다. 따라서 평문으로 저장하다 암호화가 실행되면 또는 취소되면 해당 시점부터 암호화가 진행되거나 취소된다.

따라서 암호화 키는 바로 삭제가 아닌 어느정도 기간동안 필요할수 있다.

## 바이너리 로그 암호화
바이너리 로그는 언두, 리두 로그보다 긴 시간동안 데이터를 보관하기에 보안에 중요하다.