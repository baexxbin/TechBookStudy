# 데이터 압축

MySQL서버에서 디스크에 저장된 파일의 크기는 쿼리의 처리 성능과도 직결되지만, 백업 및 복구 시간과도 연결된다.

디스크 파일이 클수록 처리하기 위한 페이지의 수가 많아져 자주 InnoDB에 페이지를 읽어야하고, 더티 페이지가 더 자주 디스크로 기록돼야한다.

이는 백업, 복구에 영향을 미친다.

압축방식은 테이블 압축과 페이지 압축 두가지 종류로 구분할수 있다.

## 페이지 압축

페이지 압축은 디스크에 저장하는 시점에 데이터 페이지가 압축되어 저장되고, 데이터 페이지를 읽는 시점에 압축을 해제한다.

즉, 버퍼 풀에 데이터 페이지가 한번 적재되면 InnoDB엔진은 압축이 해제된 상태로만 데이터 페이지를 관리한다.

문제는 적어도 하나의 테이블이 동일한 크기의 페이지로 통일돼야하는데, 압축한 결과의 용량이 얼마나 될지 예측이 불가능하다는 것이다.

따라서 페이지 압축 기능은 운영체제별로 특정 버전의 파일 시스템에서만 지원되는 `펀치홀`을 사용한다.

하지만 운영체제뿐만 아니라 하드웨어 자체에서도 해당 기능을 지원해야 사용가능하고, 파일 시스템 관련 명령어가 펀치홀을 지원하지 못하기때문에 거의 사용하지 않는다.

## 테이블 압축

테이블 압축은 운영체제나 하드웨어에 대한 제약 없이 사용할 수 있기 때문에 더 확용도가 높다.

우선 디스크의 데이터 파일 크기를 줄일수 있다눈 장점이 있다.

하지만 몇몇 단점도 존재한다.
> - 버퍼풀 공간 활용률이 낮음
> - 쿼리 처리 성능이 낮음
> - 빈번한 데이터 변경시 압축률이 떨어짐

### 압축 테이블 생성

테이블 압축을 사용하기 위한 전제 조건으로 압축을 사용하려는 테이블이 별도의 테이블 스페이스를 사용해야한다.

테이블 압축을 사용하는 테이블은 압축된 페이지의 목표크기를 명시해야한다. 그래서, 만약 압축과정을 거치고, 목표크기보다 크다면 페이지를 스플릿해준다.

(사진넣기)

테이블 압축 방식에서 가장 중요한 것은 원본 데이터 페이지의 압축결과가 목표크기보다 작거나 같을때까지 반복해서 페이지를 스플릿하는것이다. 따라서 목표크기가 잘못 설정되면 MySQL서버의 처리 성능이 급격히 떨어질수
있으니 주의해야한다.

### KEY_BLOCK_SIZE결정

테이블 압축에서 가장 중요한 부분은 압축된 결과가 어느정도 될지를 예측해서 KEY_BLOCK_SIZE를 결정하는 것이다. 왜냐하면 목표크기를 적절히 설정하지 않는다면, 불필하게 압축을 여러번하여 시간이 오래걸릴수도
있기에, 성능에 민감하면 압축을 진행하지 않는것이 좋을수도 있다.

### 압축된 페이지의 버퍼풀 적재 및 사용

InnoDB는 압축된 테이블의 데이터 페이지를 버퍼풀에 적재하면 압축된 상태와 압축이 해제된 상태 2개 버전을 관리한다. 따라서 디스크에서 읽은 상태 그대로의 데이터 페이지목록을 관리하는 LRU리스트와 압축된
페이지의 압축해제버전인 Unzip_LRU리스트를 별도로 관리한다.

MySQL서버에는 압축된 테이블과 압축되지 않은 테이블이 공존하므로, 결국 LRU리스트는 다음과 같이 압축된 페이지와 압축되지 않은 페이지를 모두 가질수 있다.

이는 버퍼풀의 공간을 이중으로 사용함으로써 메모리를 낭비하는 효과를 가진다. 또 다른 문제점으로는 압축된 페이지에서 데이터를 읽거나 변경하기 위해서는 압축을 해제해야하는데, 이는 CUP를 상대적으로 많이 소모하는
작업이다.

이러한 두가지 단점을 보완하기 위해 Unzip_LRU리스트를 별도로 관리하다, 요청에 따라 적절히 처리한다.

### 테이블 압축 관련 설정
페이지의 압축 실패율을 낮추기 위해 필요한 튜닝포인트를 제공한다.